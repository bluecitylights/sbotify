name: CI/CD Base

# ðŸ’¡ FIX 6: Voeg permissions toe aan het workflow-niveau, zodat alle downstream jobs 
# het OIDC-token voor Workload Identity kunnen genereren.
permissions:
  contents: read
  id-token: write

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      dockerfile:
        required: true
        type: string
      folder:
        required: true
        type: string
      ref_name: # ðŸ’¡ NIEUW: Accepteer de branch-naam van de aanroepende workflow.
        required: true
        type: string
    # ðŸ’¡ FIX 1: De base workflow moet de complete set van secrets accepteren.
    secrets:
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      SERVICE_ACCOUNT_EMAIL:
        required: true
      GCP_PROJECT:
        required: true
      REGION:
        required: true
      APP:
        required: true
      # NIEUW: PROJECT_NUMBER is nodig voor het construeren van interne service URL's.
      PROJECT_NUMBER:
        required: true
      # NIEUW: GEMINI_API_KEY is alleen nodig voor de 'chat' service, dus optioneel (false).
      GEMINI_API_KEY:
        required: false

jobs:
  tests:
    uses: ./.github/workflows/tests.yml
    with:
      folder: ${{ inputs.folder }}

  build-and-push:
    needs: tests
    # De permissions zijn nu op workflow-niveau gedefinieerd (FIX 6), dus deze kunnen weg.
    uses: ./.github/workflows/build-and-push.yml
    with:
      service: ${{ inputs.service }}
      dockerfile: ${{ inputs.dockerfile }}
    # ðŸ’¡ FIX 2: Stuur alle geheimen expliciet door naar de 'build-and-push' job.
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT_EMAIL: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      REGION: ${{ secrets.REGION }}
      APP: ${{ secrets.APP }}
  deploy:
    needs: build-and-push
    # ðŸ’¡ GEFIXT: De 'deploy' job wordt nu uitgevoerd op ELKE branch, zolang de build succesvol was.
    if: needs.build-and-push.result == 'success'
    # De permissions zijn nu op workflow-niveau gedefinieerd (FIX 6), dus deze kunnen weg.
    uses: ./.github/workflows/deploy.yml
    with:
      service: ${{ inputs.service }}
      image: ${{ needs.build-and-push.outputs.image }}
    # ðŸ’¡ FIX 3: Stuur alle geheimen expliciet door naar de 'deploy' job.
    secrets:
      WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
      SERVICE_ACCOUNT_EMAIL: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      REGION: ${{ secrets.REGION }}
      APP: ${{ secrets.APP }}
      PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
